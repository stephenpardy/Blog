<!DOCTYPE html>
<meta charset="utf-8">
<link href="/bootstrap-3.2.0-dist/css/bootstrap.min.css" rel="stylesheet">

<style> /* set the CSS */

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
  opacity: 0.7;
}
.label {
  font-size: 12px;
  color: black;
}
.selected {
  stroke-width: 3px;
  opacity: 1;
}

.profInUse{
  background-color: steelblue;
}

.hidden {
  stroke-width: 0px;
}

.nameBox {
  border-color: black;
  border-style: solid;
  background-color: none;
  fill: #111;
}

.paperButtonOff {
  opacity: 0.5;
}

.notUsable {
  background-color: #eee;
}

button {
  opacity: 0.8;
}

button:hover {
  opacity: 1;
}

.svg-container {
    display: inline-block;
    position: relative;
    width: 75%;
    padding-bottom: 45%; /* aspect ratio */
    vertical-align: middle;
    overflow: hidden;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}

</style>
<body>

<div class="row">
    <div class="col-sm-7 col-sm-offset-1">
      <div class='row'>
        <div class='col-xs-12'>
          <h3> Professors: </h3>
        </div>
      </div>
      <div class='row'>
      <div class='col-xs-12'>
      <p>
      <button type = "button" class = "btn btn-secondary profInUse"
        onclick="$(this).toggleClass('profInUse'); update_profs('Barger, A')"
        onmouseover="profLineSelect('Barger, A')" onmouseout="profLineDeSelect('Barger, A')">Amy Barger</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('DOnghia, E')"
        onmouseover="profLineSelect('DOnghia, E')" onmouseout="profLineDeSelect('DOnghia, E')">Elena D'Onghia</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Bershady, M')"
        onmouseover="profLineSelect('Bershady, M')" onmouseout="profLineDeSelect('Bershady, M')">Matt Bershady</button>
        <button type = "button" class = "btn btn-secondary"
          onclick="$(this).toggleClass('profInUse'); update_profs('Heinz, S')"
          onmouseover="profLineSelect('Heinz, S')" onmouseout="profLineDeSelect('Heinz, S')">Sebastian Heinz</button>
      </p>
      </div>
      </div>
      <div class='row'>
      <div class='col-xs-12'>
      <p>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Benjamin, R')"
        onmouseover="profLineSelect('Benjamin, R')" onmouseout="profLineDeSelect('Benjamin, R')">Bob Benjamin</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Erb, Dawn')"
        onmouseover="profLineSelect('Erb, Dawn')" onmouseout="profLineDeSelect('Erb, Dawn')">Dawn Erb</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Gallagher, John S, III.')"
        onmouseover="profLineSelect('Gallagher, John S, III.')" onmouseout="profLineDeSelect('Gallagher, John S, III.')">Jay Gallagher</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Haffner, M')"
        onmouseover="profLineSelect('Haffner, M')" onmouseout="profLineDeSelect('Haffner, M')">Matt Haffner</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Hooper, E')"
        onmouseover="profLineSelect('Hooper, E')" onmouseout="profLineDeSelect('Hooper, E')">Eric Hooper</button>
      </p>
      </div>
      </div>
      <div class='row'>
      <div class='col-xs-12'>
      <p>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Lazarian, A')"
        onmouseover="profLineSelect('Lazarian, A')" onmouseout="profLineDeSelect('Lazarian, A')">Alex Lazarian</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Mathieu, R')"
        onmouseover="profLineSelect('Mathieu, R')" onmouseout="profLineDeSelect('Mathieu, R')">Bob Mathieu</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Stanimirovic, S')"
        onmouseover="profLineSelect('Stanimirovic, S')" onmouseout="profLineDeSelect('Stanimirovic, S')">Snezana Stanimirovic</button>
      </p>
      </div>
      </div>
      <div class='row'>
      <div class='col-xs-12'>
      <p>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Tremonti, C')"
        onmouseover="profLineSelect('Tremonti, C')" onmouseout="profLineDeSelect('Tremonti, C')">Christy Tremonti</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Wakker, B')"
        onmouseover="profLineSelect('Wakker, B')" onmouseout="profLineDeSelect('Wakker, B')">Bart Wakker</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Wilcots, E')"
        onmouseover="profLineSelect('Wilcots, E')" onmouseout="profLineDeSelect('Wilcots, E')">Eric Wilcots</button>
      <button type = "button" class = "btn btn-secondary"
        onclick="$(this).toggleClass('profInUse'); update_profs('Zweibel, E')"
        onmouseover="profLineSelect('Zweibel, E')" onmouseout="profLineDeSelect('Zweibel, E')">Ellen Zweibel</button>
      </p>
      </div>
      </div>


      </div>
</div> <!-- row -->
<div class='row'>
  <div class='col-sm-7 col-sm-offset-1'>
    <div id='chart'></div>
    <div id='chartCumulative'></div>
  </div>
  <div class='col-sm-3'>
    <div class='row'>
      <button id='splitButton' type = "button" class = "btn btn-secondary" onclick="split()"><span id='splitButtonSpan'>Show top ten papers</span></button>
    </div>
    <div class='row'>
      <div id='papernameschart'></div>
    </div>
  </div>
</div>

<h4> Based on data from the <a href="http://adsabs.harvard.edu/">ADS</a></h4>

<!-- load the d3.js library -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>



<script>

var Npapers = 10;

var t = d3.transition()
    .duration(750)
    .ease(d3.easeLinear);


var t2 = d3.transition()
    .duration(500)
    .delay(50)
    .ease(d3.easeLinear);


// set the dimensions and margins of the graph
var margin = {top: 20, right: 20, bottom: 40, left: 60},
    width = 600 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom,
    sideWidth = 400 - margin.left - margin.right
    sideHeight = 800 - margin.top - margin.bottom;

// parse the date / time
var parseTime = d3.timeParse("%Y");

// set the ranges
var x = d3.scaleTime().range([0, width]);
var y = d3.scaleLinear().range([height, 0]);

var yCumulative = d3.scaleLinear().range([height, 0]);

// define the line
var valueline = d3.line()
    .x(function(d) { return x(parseTime(+d.year)); })
    .y(function(d) { return y(+d.n); });

// define the line
var valuelineCumulative = d3.line()
    .x(function(d) { return x(parseTime(+d.year)); })
    .y(function(d) { return yCumulative(+d.cumulative_n); });

var svg = d3.select("#chart")
            .classed("svg-container", true)
            .append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 "+ (width + margin.left + margin.right) +
                  " " + (height + margin.top + margin.bottom))
            .classed("svg-content-responsive", true)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var svgCumulative = d3.select("#chartCumulative")
                      .classed("svg-container", true)
                      .append("svg")
                      //.attr("width", width + margin.left + margin.right)
                      //.attr("height", height + margin.top + margin.bottom)
                      .attr("preserveAspectRatio", "xMinYMin meet")
                      .attr("viewBox", "0 0 "+ (width + margin.left + margin.right) +
                            " " + (height + margin.top + margin.bottom))
                      .classed("svg-content-responsive", true)
                    .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var svgnames = d3.select("#papernameschart")
            .append("svg")
            .attr("width", sideWidth + margin.left + margin.right)
            .attr("height", sideHeight + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Get the data

init_names = ['Barger, A']

var _citations = null;

var profs = {}
var papers = {}

d3.json("/resources/citations/citations.json", function(error, citations) {
  if (error) throw error;

  _citations = citations

  // Scale the range of the data

  var xmin = null;
  var xmax = null;
  var ymax = null;
  var ymax_cumulative = null;

  init_names.forEach(function(n){

    profs[n] = citations[n]['all'];

    citations[n]['all'].forEach(function(d){
      xmin = d3.min([xmin, parseTime(+d.year)]);
      xmax = d3.max([xmax, parseTime(+d.year)]);
      ymax = d3.max([ymax, +d.n]);
      ymax_cumulative = d3.max([ymax_cumulative, +d.cumulative_n]);
    });
  });

  x.domain([xmin, xmax]);
  y.domain([0, ymax]);

  yCumulative.domain([0, ymax_cumulative]);

  // Add the valueline path.
  svg.selectAll(".line")
     .data(d3.entries(profs), function(d){ return 'yearly'+d['key'].replace(/\W/g, '')})
     .enter()
     .append("path")
     .attr('id', function(d){ return 'yearly'+d['key'].replace(/\W/g, '')})
     .attr("class", "line")
     .attr("d", function(d){ return valueline(d['value'])});

  // Add the X Axis
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    // text label for the x axis
  svg.append("text")
      .attr("transform",
            "translate(" + (width/2) + " ," +
                           (height + margin.top + 20) + ")")
      .style("text-anchor", "middle")
      .text("Year");

  // Add the Y Axis
  svg.append("g")
      .attr("class", "y axis")
      .call(d3.axisLeft(y));

  // text label for the y axis
  svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Citations per year");

  //cumulative plot
  svgCumulative.selectAll(".line")
     .data(d3.entries(profs), function(d){ return 'cumulative'+d['key'].replace(/\W/g, '')})
     .enter()
     .append("path")
     .attr('id', function(d){ return 'cumulative'+d['key'].replace(/\W/g, '')})
     .attr("class", "line")
     .attr("d", function(d){ return valuelineCumulative(d['value'])});

  // Add the X Axis
  svgCumulative.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    // text label for the x axis
  svgCumulative.append("text")
      .attr("transform",
            "translate(" + (width/2) + " ," +
                           (height + margin.top + 20) + ")")
      .style("text-anchor", "middle")
      .text("Year");

  // Add the Y Axis
  svgCumulative.append("g")
      .attr("class", "y axis")
      .call(d3.axisLeft(yCumulative));

  // text label for the y axis
  svgCumulative.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Total citations");

});

function update_profs(name){
  if (d3.keys(papers).length > 1){
    papers = {}
    paper_names = []
    svgnames.selectAll("g").remove();
    document.getElementById('splitButtonSpan').textContent = 'All papers'
  }

  if (profs.hasOwnProperty(name)){
    delete profs[name]
    reload(profs)

  } else {
    profs[name] = _citations[name]['all'];
    reload(profs)
  }

  if (d3.values(profs).length > 1) {
    splitButton = d3.select('#'+'splitButton');
    splitButton.classed('notUsable', true);
  } else {
    splitButton = d3.select('#'+'splitButton');
    splitButton.classed('notUsable', false);
  }
};

function reload(data){
  // Scale the range of the data

  var xmin = null;
  var xmax = null;
  var ymax = null;

  var ymax_cumulative = null;

  d3.entries(data).forEach(function(d1){
    d1['value'].forEach(function(d2){
        xmin = d3.min([xmin, parseTime(+d2.year)]);
        xmax = d3.max([xmax, parseTime(+d2.year)]);
        ymax = d3.max([ymax, +d2.n]);
        ymax_cumulative = d3.max([ymax_cumulative, +d2.cumulative_n]);
      });
  });

  x.domain([xmin, xmax]);
  y.domain([0, ymax]);

  yCumulative.domain([0, ymax_cumulative]);

  // Add the X Axis
  svg.selectAll('.x.axis')
     .transition(t)
     .call(d3.axisBottom(x));

  // Add the Y Axis
  svg.selectAll('.y.axis')
     .transition(t)
     .call(d3.axisLeft(y));

  lines = svg.selectAll(".line")
     .data(d3.entries(data), function(d){ return 'yearly'+d['key'].replace(/\W/g, '')});

  lines.enter()
     .append("path")
     .attr("class", "line")
     .attr('id', function(d){ return 'yearly'+d['key'].replace(/\W/g, '')})
     .attr("d", function(d){ return valueline(d['value'])});

  lines.transition(t)
     .attr("d", function(d){ return valueline(d['value'])});

  lines.exit()
       .remove();

  //cumulative plot

  // Add the X Axis
  svgCumulative.selectAll('.x.axis')
     .transition(t)
     .call(d3.axisBottom(x));

  // Add the Y Axis
  svgCumulative.selectAll('.y.axis')
     .transition(t)
     .call(d3.axisLeft(yCumulative));

  linesCumulative = svgCumulative.selectAll(".line")
     .data(d3.entries(data), function(d){ return 'cumulative'+d['key'].replace(/\W/g, '')});

  linesCumulative.enter()
     .append("path")
     .attr("class", "line")
     .attr('id', function(d){ return 'cumulative'+d['key'].replace(/\W/g, '')})
     .attr("d", function(d){ return valuelineCumulative(d['value'])});

  linesCumulative.transition(t)
     .attr("d", function(d){ return valuelineCumulative(d['value'])});

  linesCumulative.exit()
       .remove();

}

function split(){
  prof_names = d3.keys(profs);
  if (prof_names.length > 1){
    console.log('Not allowed');
  } else {
    if (d3.keys(papers).length > 0){
      papers = {}
      paper_names = []
      svgnames.selectAll("g").remove();
      document.getElementById('splitButton').textContent = 'Show top ten papers'
      reload(profs);
    } else {
      prof_name = prof_names[0];
      document.getElementById('splitButton').textContent = 'Show all papers'
      setup_papers_plot(prof_name);
    }
  }
}

function setup_papers_plot(name){

  papers = {}

  paper_names = []

  d3.entries(_citations[name]).forEach(function(d){
    if (d['key'] != 'all'){
      paper_names.push({'name': d['key'],
        'tot': d3.sum(d['value'], function(d2){ return +d2.n })});
    }
  });

  paper_names.sort(function(a, b){
    if (a['tot'] < b['tot']){
      return 1;
    }
    if (a['tot'] > b['tot']){
      return -1;
    }
    return 0;
  });

  paper_names = paper_names.slice(0, 10);

  paper_names.forEach(function(d, i){
        papers[d['name']] = _citations[name][d['name']];
  });

  var boxHeight = 20;
  var boxWidth = 300;

  var paperBoxes = svgnames.selectAll("g")
                           .data(paper_names)
                           .enter().append("g")
                           .attr('class', 'nameBox')
                           .on('mouseover', function(d){
                              d3.select(this)
                                 .transition()
                                 .delay(10)
                                 .style('fill', 'steelblue')
                                 .attr("transform", function(d){
                                  translation = getTransformation(this.getAttribute("transform"));
                                  newx = translation.translateX + 30;
                              return this.getAttribute("transform") +
                                "translate(-" + newx + ",0)";})
                              paperLineSelect(d);
                           })
                           .on('mouseout', function(d){
                              el = d3.select(this);
                              oldFill = el.style('fill');
                              el.transition()
                                 .delay(10)
                                 .style('fill', '#111')
                                 .attr("transform",  function(d){
                                  translation = getTransformation(this.getAttribute("transform"));
                                  newx = -translation.translateX;
                              return this.getAttribute("transform") +
                                "translate(" + newx + ",0)";});
                              paperLineDeSelect(d);
                           })
                           .on('click', function(d){
                              paperButton = d3.select(this)
                              paperButton.classed("paperButtonOff", !paperButton.classed("paperButtonOff"));
                              paperLineToggle(d);
                            });


  paperBoxes.append("text")
            .attr("x", 10)
            .attr("y", 10)
            .attr("dy", ".35em")
            .text(function(d) { return d['name']; })
            .attr("font-family", "sans-serif")
            .attr("font-size", "15px")
            .call(wrap, boxWidth);

  svg.selectAll(".line").remove();
  svgCumulative.selectAll(".line").remove();

  reload(papers)
}


function paperLineToggle(paper){
  paperLine = d3.select('#'+'yearly'+paper['name'].replace(/\W/g, ''));
  if (paperLine.style('stroke-width') == '3px'){
    paperLine.transition().style('stroke-width', '0px');
  } else {
    paperLine.transition().style('stroke-width', '3px');
  }

  paperLine = d3.select('#'+'cumulative'+paper['name'].replace(/\W/g, ''));

  if (paperLine.style('stroke-width') == '3px'){
    paperLine.transition().style('stroke-width', '0px');
  } else {
    paperLine.transition().style('stroke-width', '3px');
  }

}

function profLineSelect(prof){
  paperLine = d3.select('#'+'yearly'+prof.replace(/\W/g, ''));
  paperLine.classed('selected', true);

  paperLine = d3.select('#'+'cumulative'+prof.replace(/\W/g, ''));
  paperLine.classed('selected', true);
}

function profLineDeSelect(prof){
  paperLine = d3.select('#'+'yearly'+prof.replace(/\W/g, ''));
  paperLine.classed('selected', false);

  paperLine = d3.select('#'+'cumulative'+prof.replace(/\W/g, ''));
  paperLine.classed('selected', false);
}

function paperLineSelect(paper){
  paperLine = d3.select('#'+'yearly'+paper['name'].replace(/\W/g, ''));
  paperLine.classed('selected', true);

  paperLine = d3.select('#'+'cumulative'+paper['name'].replace(/\W/g, ''));
  paperLine.classed('selected', true);
}

function paperLineDeSelect(paper){
  paperLine = d3.select('#'+'yearly'+paper['name'].replace(/\W/g, ''));
  paperLine.classed('selected', false);

  paperLine = d3.select('#'+'cumulative'+paper['name'].replace(/\W/g, ''));
  paperLine.classed('selected', false);
}


function wrap(text, width) {
  var offset = 0;
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em"),
        g = d3.select(this.parentNode),
        rect = d3.select(this.parentNode.firstChild);
    g.attr("transform", "translate(0," + offset + ")");
    offset = offset + 35;

    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        rect.attr('height', +rect.attr('height')+15);
        offset = offset + 15;
      }
    }
    //console.log(offset);
  });
}


function getTransformation(transform) {
  // Create a dummy g for calculation purposes only. This will never
  // be appended to the DOM and will be discarded once this function 
  // returns.
  var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
  
  // Set the transform attribute to the provided string value.
  g.setAttributeNS(null, "transform", transform);
  
  // consolidate the SVGTransformList containing all transformations
  // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get
  // its SVGMatrix. 
  var matrix = g.transform.baseVal.consolidate().matrix;

  // Below calculations are taken and adapted from the private function
  // transform/decompose.js of D3's module d3-interpolate.
  var {a, b, c, d, e, f} = matrix;   // ES6, if this doesn't work, use below assignment
  // var a=matrix.a, b=matrix.b, c=matrix.c, d=matrix.d, e=matrix.e, f=matrix.f; // ES5
  var scaleX, scaleY, skewX;
  if (scaleX = Math.sqrt(a * a + b * b)) a /= scaleX, b /= scaleX;
  if (skewX = a * c + b * d) c -= a * skewX, d -= b * skewX;
  if (scaleY = Math.sqrt(c * c + d * d)) c /= scaleY, d /= scaleY, skewX /= scaleY;
  if (a * d < b * c) a = -a, b = -b, skewX = -skewX, scaleX = -scaleX;
  return {
    translateX: e,
    translateY: f,
    rotate: Math.atan2(b, a) * 180 / Math.PI,
    skewX: Math.atan(skewX) * 180 / Math.PI,
    scaleX: scaleX,
    scaleY: scaleY
  };
}
</script>
<script src="/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
</body>
